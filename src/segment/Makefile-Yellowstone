all: nu-segment.exe tests

tests: imreconTest.exe imreconOptimizeTest.exe imreconOptimizeProfiler.exe localMaximaTest.exe miscTest.exe imfillTest.exe bwareaopenTest.exe

CXX=/usr/bin/g++-4.4 
CXXFLAGS=-fPIC -pg -O3 #-g -msse4.2 -fopenmp
#CXX=icpc
#CXXFLAGS=-g -fast -openmp -msse4.2

NVCC=nvcc
NVCC_FLAGS=--ptxas-options=-v -m64 -g -arch=sm_20 -O3 -ptx #-G -Xcompiler -fPIC "-arch=sm_12"  -O3
NVCC_INCLUDE=-I/usr/local/cuda/include
CUDA_LIBS= -L/usr/local/cuda/lib64 -lcudart

CUDA_CV_INCLUDE =-I/home/tcpan/PhD/path/ext/OpenCV-2.3.0/modules/gpu/src -I/home/tcpan/PhD/path/ext/OpenCV-2.3.0/modules/gpu/src/cuda -I/usr/local/include -I/usr/local/include/opencv2/gpu


RM=/bin/rm -rf

CUDA_SRC = cuda/reconstruction_kernel.cu cuda/pixel-ops.cu cuda/change_kernel.cu cuda/imreconstruct_binary_kernel.cu cuda/imreconstruct_int_kernel.cu cuda/imreconstruct_float_kernel.cu
GPU_SRC = HistologicalEntitiesGPU.cpp MorphologicOperationsGPU.cpp PixelOperationsGPU.cpp

LIB_SRCH = HistologicalEntities.h MorphologicOperations.h PixelOperations.h utils.h

LIB_SRC = HistologicalEntities.cpp MorphologicOperations.cpp PixelOperations.cpp
GPU_LIB_SRC = ${CUDA_SRC} ${GPU_SRC}

LIB_SRCO = ${LIB_SRC:.cpp=.o}
GPU_LIB_SRCO = ${CUDA_SRC:.cu=.o} ${GPU_SRC:.cpp=.o}

CXXFLAGS	+= `pkg-config opencv --cflags`
CXXFLAGS	+= ${NVCC_INCLUDE}
CXXFLAGS	+= ${CUDA_CV_INCLUDE}
CXXFLAGS	+= -DHAVE_CUDA
LDFLAGS		+= `pkg-config opencv --libs`
LDFLAGS		+= -lopencv_gpu
LDFLAGS		+= ${CUDA_LIBS}

libsegment.so: ${LIB_SRCO} ${GPU_LIB_SRCO} ${LIB_SRCH}
	$(CXX) ${CXX_FLAGS} $(LDFLAGS) -shared -o libsegment.so ${LIB_SRCO} ${GPU_LIB_SRCO}

clean:
	$(RM) *.o *.exe *.so cuda/*.o
	
%.o: %.cpp ${LIB_SRCH}
	$(CXX) $(CXXFLAGS) $(LDFLAGS) -o $@ -c $<

%.o: %.c ${LIB_SRCH}
	$(CXX) $(CXXFLAGS) $(LDFLAGS) -o $@ -c $<
	
%.o: %.cu
	$(NVCC) $(NVCC_FLAGS) $(NVCC_INCLUDE) ${CUDA_CV_INCLUDE} -o $@ -c $<
	
%.exe: %.o ${LIB_SRCO} ${GPU_LIB_SRCO} ${LIB_SRCH}
	$(CXX) $(CXXFLAGS) $(LDFLAGS) -o $@ $< ${LIB_SRCO} ${GPU_LIB_SRCO}
	