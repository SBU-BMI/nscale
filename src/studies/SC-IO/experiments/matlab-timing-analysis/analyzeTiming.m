clear all;
close all;

% open the file
filenames = {'../strong-checkpoint-segtest-yellowstone/scio-segtest-mpi2-timing.csv',...
    '../strong-checkpoint-segtest-yellowstone/scio-segtest-mpi3-timing.csv',...
    '../strong-checkpoint-segtest-yellowstone/scio-segtest-mpi5-timing.csv',...
    '../strong-checkpoint-segtest-yellowstone/scio-segtest-mpi9-timing.csv',...
    '../strong-checkpoint-validation-ccicluster/strong-checkpoint-validation-ccicluster-timing.5.csv',...
    '../strong-checkpoint-validation-ccicluster/strong-checkpoint-validation-ccicluster-timing.9.csv',...
    '../strong-checkpoint-validation-ccicluster/strong-checkpoint-validation-ccicluster-timing.17.csv',...
    '../strong-checkpoint-validation-ccicluster/strong-checkpoint-validation-ccicluster-timing.33.csv',...
    '../strong-checkpoint-validation-ccicluster/strong-checkpoint-validation-ccicluster-timing.65.csv',...
     '../strong-checkpoint-validation-ccicluster/strong-checkpoint-validation-ccicluster-timing.129.csv',...
    '../weak-checkpoint-validation-ccicluster/weak-checkpoint-validation-ccicluster-timing.5.csv',...
    '../weak-checkpoint-validation-ccicluster/weak-checkpoint-validation-ccicluster-timing.9.csv',...
    '../weak-checkpoint-validation-ccicluster/weak-checkpoint-validation-ccicluster-timing.17.csv',...
    '../weak-checkpoint-validation-ccicluster/weak-checkpoint-validation-ccicluster-timing.33.csv',...
    '../weak-checkpoint-validation-ccicluster/weak-checkpoint-validation-ccicluster-timing.65.csv',...
    '../weak-checkpoint-validation-ccicluster/weak-checkpoint-validation-ccicluster-timing.129.csv',...
    };
ofns = {'../strong-checkpoint-segtest-yellowstone/scio-segtest-mpi2-summary.csv',...
    '../strong-checkpoint-segtest-yellowstone/scio-segtest-mpi3-summary.csv',...
    '../strong-checkpoint-segtest-yellowstone/scio-segtest-mpi5-summary.csv',...
    '../strong-checkpoint-segtest-yellowstone/scio-segtest-mpi9-summary.csv',...
    '../strong-checkpoint-validation-ccicluster/strong-checkpoint-validation-ccicluster-summary.5.csv',...
    '../strong-checkpoint-validation-ccicluster/strong-checkpoint-validation-ccicluster-summary.9.csv',...
    '../strong-checkpoint-validation-ccicluster/strong-checkpoint-validation-ccicluster-summary.17.csv',...
    '../strong-checkpoint-validation-ccicluster/strong-checkpoint-validation-ccicluster-summary.33.csv',...
    '../strong-checkpoint-validation-ccicluster/strong-checkpoint-validation-ccicluster-summary.65.csv',...
     '../strong-checkpoint-validation-ccicluster/strong-checkpoint-validation-ccicluster-summary.129.csv',...
    '../weak-checkpoint-validation-ccicluster/weak-checkpoint-validation-ccicluster-summary.5.csv',...
    '../weak-checkpoint-validation-ccicluster/weak-checkpoint-validation-ccicluster-summary.9.csv',...
    '../weak-checkpoint-validation-ccicluster/weak-checkpoint-validation-ccicluster-summary.17.csv',...
    '../weak-checkpoint-validation-ccicluster/weak-checkpoint-validation-ccicluster-summary.33.csv',...
    '../weak-checkpoint-validation-ccicluster/weak-checkpoint-validation-ccicluster-summary.65.csv',...
    '../weak-checkpoint-validation-ccicluster/weak-checkpoint-validation-ccicluster-summary.129.csv',...
    };


for i = 1:length(filenames)
    filenames{i}
    
    [header type startt endt location] = readComputeAndIOTiming(filenames{i});
    [ concurrencyAll nodes concurrencyPerNode ] = ...
        ComputeAndIOConcurrency( header, type, startt, endt, location );
    
%     duration = concurrency{1,1}(1,end) - concurrency{1,1}(1,1);
%     intervals = concurrency{1,1}(1,2:end) - concurrency{1,1}(1, 1:end-1);
%     totaltime = concurrency{1,2}(3,1:end-1) * intervals';
%     averageIO = totaltime / duration
%     nodetimeaverageIO = averageIO / cpuCount;
%     totaltime = concurrency{1,2}(2,1:end-1) * intervals';
%     averageCompute = totaltime / duration
%     nodetimeaverageCompute = averageCompute / cpuCount;

    ofn = ofns{i};
    dlmwrite(ofn, ['ALL'], 'delimiter', '');
    dlmwrite(ofn, concurrencyAll{1,1}, '-append', 'delimiter', ',', 'precision', '%ld');
    dlmwrite(ofn, concurrencyAll{1,2}, '-append', 'delimiter', ',');
    
    for j = 1 : length(nodes)
        dlmwrite(ofn, nodes{j}, '-append', 'delimiter', '');
        dlmwrite(ofn, concurrencyPerNode{j,1}{1,1}, '-append', 'delimiter', ',', 'precision', '%ld');
        dlmwrite(ofn, concurrencyPerNode{j,1}{1,2}, '-append', 'delimiter', ',');
    end
    
end